!function(e){const a="umami-share-cache-";e.getUmamiShareData=function(t,o){return e.__umamiSharePromise||(e.__umamiSharePromise=async function(e,t){const o=a+t,r=localStorage.getItem(o);if(r)try{const e=JSON.parse(r);if(Date.now()-e.timestamp<36e5)return console.log("[Umami] Using cached token for",t),e.value}catch{localStorage.removeItem(o)}console.log("[Umami] Fetching new token for",t);const i=await fetch(`${e}/api/share/${t}`);if(!i.ok)throw new Error("获取 Umami 分享信息失败");const n=await i.json();return localStorage.setItem(o,JSON.stringify({timestamp:Date.now(),value:n})),n}(t,o).catch((a=>{throw delete e.__umamiSharePromise,a}))),e.__umamiSharePromise},e.clearUmamiShareCache=function(t){const o=a+t;localStorage.removeItem(o),localStorage.removeItem("umami-share-cache"),delete e.__umamiSharePromise},e.fetchUmamiStats=async function(a,t,o){return async function r(i=!1){const{websiteId:n,token:m}=await e.getUmamiShareData(a,t),s=Date.now(),c=new URLSearchParams({startAt:0,endAt:s,timezone:"Asia/Shanghai",compare:!1,...o}),h=`${a}/api/websites/${n}/stats?${c.toString()}`;console.log("[Umami] Fetching stats:",h);const l=await fetch(h,{headers:{"x-umami-share-token":m}});if(!l.ok){if(401===l.status&&!i)return console.warn("[Umami] Token expired or invalid, retrying..."),e.clearUmamiShareCache(t),r(!0);throw new Error("获取统计数据失败: "+l.status)}return await l.json()}()}}(window);